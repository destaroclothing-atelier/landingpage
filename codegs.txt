/**
 * CONFIG
 * HARAP GANTI DENGAN ID GOOGLE SHEET DAN FOLDER DRIVE ANDA
 */
var SHEET_ID = "1qIwM_Ue9dGiR69oiaE72uWEhqfb-dDaLNSNIgLEwhd4"; // GANTI ID INI
var SHEET_NAME = "Kirim";
var DRIVE_FOLDER_ID = "1BGxv1eEaftiWuu_XfnWDNb-F3BcZ7Y_2"; // GANTI ID INI

/**
 * MAIN PAGE – return pure HTML, no templating
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile("index")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .setTitle("Surat Jalan – DESTARO ATELIER");
}

/**
 * GET LIST OF ORDERS
 */
function getAllNoOrders() {
  try {
    var ss = SpreadsheetApp.openById(SHEET_ID);
    var sh = ss.getSheetByName(SHEET_NAME);
    if (!sh) return [];

    var last = sh.getLastRow();
    if (last < 2) return [];
    var values = sh.getRange(2, 2, last - 1).getValues().flat();

    var clean = [...new Set(values
      .map(function(v) { return v ? v.toString().trim() : ""; })
      .filter(function(v) { return v !== ""; }))];
    return clean.sort();
  } catch (err) {
    throw new Error("Gagal memuat daftar order: " + err);
  }
}

/**
 * GET ORDER DETAILS for selected No Order
 */
function getOrderDataForDelivery(noOrder) {
  try {
    var ss = SpreadsheetApp.openById(SHEET_ID);
    var sh = ss.getSheetByName(SHEET_NAME);
    if (!sh) throw new Error("Sheet tidak ditemukan");
    
    var range = sh.getDataRange();
    var values = range.getValues();
    var header = values[0];
    var data = values.slice(1);
    
    var rowData = data.find(function(row) { 
        return row[1] && String(row[1]).trim() === String(noOrder).trim(); 
    });
    
    if (!rowData) {
      return null;
    }

    var rowIndex = values.findIndex(function(row) { return row === rowData; }) + 1;
    var row = rowData;
    
    function formatDateDisplay(date) {
      if (!date || !(date instanceof Date)) return "";
      return Utilities.formatDate(date, ss.getSpreadsheetTimeZone(), 'dd/MM/yyyy'); 
    }
    
    function formatDateHtml(date) {
      if (!date || !(date instanceof Date)) return "";
      return Utilities.formatDate(date, ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd');
    }
    
    function getSizes(row) {
      var arr = [];
      var total = 0;
      // Kolom E sampai K (index 4 sampai 10)
      for (var i = 4; i <= 10; i++) { 
        var size = header[i]; 
        var count = row[i];
        
        if (count && count > 0) {
          arr.push(size + ": " + count);
          total += count;
        }
      }
      return { detail: arr.join("\n"), total: Math.round(total) };
    };

    var ukuran = getSizes(row);

    // Pembacaan data dari Sheet
    // M=12, N=13, O=14, P=15
    return {
      rowIndex: rowIndex,
      noOrder: row[1] || "",      // Kolom B (Index 1)
      tglOrder: formatDateDisplay(row[0]), // Kolom A (Index 0)
      tglSelesai: formatDateDisplay(row[12]), // Kolom M (Index 12)
      customer: row[2] || "",      // Kolom C (Index 2) - Customer
      alamat: row[3] || "",        // Kolom D (Index 3) - Alamat Kirim
      ukuranDetail: ukuran.detail,
      jumlahTotal: row[11] || ukuran.total, // Kolom L (Index 11) - Jumlah Total
      
      // Data yang akan diisi ulang/diperbarui:
      statusKirim: row[12] || "Proses Kirim", // Kolom M (Index 12) - Status
      tglTerima: formatDateHtml(row[13]),    // Kolom N (Index 13) - Tanggal Terima
      namaPenerima: row[14] || "",           // Kolom O (Index 14) - Nama Penerima (Sesuai Koreksi Urutan Sheet)
      ttdUrl: row[15] || "",                 // Kolom P (Index 15) - Tanda Tangan (Sesuai Koreksi Urutan Sheet)
    };
  } catch (err) {
    throw new Error("Gagal ambil data order: " + err.message);
  }
}

/**
 * SAVE DELIVERY CONFIRMATION (Menyimpan data dengan urutan disesuaikan)
 */
function saveDeliveryConfirmation(form) {
  try {
    if (!form || !form.rowIndex)
      throw new Error("Data form tidak lengkap");
    var ss = SpreadsheetApp.openById(SHEET_ID);
    var sh = ss.getSheetByName(SHEET_NAME);

    var row = parseInt(form.rowIndex, 10);
    if (row < 2) throw new Error("Row index tidak valid");
    
    var tglTerimaDate = form.tglTerima ?
      new Date(form.tglTerima + ' ' + '12:00:00') : ""; 

    var values = [
      form.statusKirim,      // Data 1: Status Kirim (M)
      tglTerimaDate,         // Data 2: Tanggal Terima (N)
      form.namaPenerima,     // Data 3: Nama Penerima (O) - KOREKSI
      form.ttdDataUrl       // Data 4: Tanda Tangan (P) - KOREKSI
    ];
    
    // Menulis 4 kolom (M, N, O, P)
    sh.getRange(row, 13, 1, 4).setValues([values]); 
    
    return { 
      success: true, 
      message: "Konfirmasi pengiriman No Order " + form.noOrder + " berhasil disimpan.",
      data: getOrderDataForDelivery(form.noOrder)
    };
  } catch (err) {
    throw new Error("Gagal menyimpan konfirmasi pengiriman: " + err.message);
  }
}

// ==========================================================
// FUNGSI UNTUK MENYIMPAN GAMBAR KE DRIVE
// ==========================================================
function saveImageToDrive(dataUrl, filename) {
  try {
    if (!dataUrl || !filename) {
      throw new Error("Data gambar atau nama file tidak valid.");
    }
    
    var base64Data = dataUrl.split(',')[1];
    var blob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/png', filename);
    var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    var file = folder.createFile(blob);
    
    // Mengembalikan URL file
    return { 
      success: true, 
      message: "Surat Jalan berhasil disimpan ke Google Drive. [Lihat File](" + file.getUrl() + ")" 
    };
  } catch (e) {
    var errorMessage = e && e.message ? e.message : e.toString();
    if (errorMessage.includes("No such folder")) {
      return { success: false, message: "Gagal menyimpan: ID folder Drive tidak ditemukan. Pastikan ID folder sudah benar."};
    }
    return { success: false, message: "Gagal menyimpan gambar ke Drive: Periksa izin Drive (Lakukan Deployment Baru & Otorisasi Ulang). Pesan: " + errorMessage };
  }
}